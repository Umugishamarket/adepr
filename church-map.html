<!DOCTYPE html>
<html lang="rw">
<head>
  <meta charset="UTF-8" />
  <title>Ikibazo Insengero - ADEPR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet/dist/leaflet.css" 
  />
  <style>
    #map {
      height: 80vh;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
    }
    header {
      background: #007b5e;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
    }
    #searchBox {
      margin: 10px auto;
      max-width: 400px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    #searchInput {
      flex: 1;
      padding: 8px 12px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #searchBtn {
      background: #007b5e;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    #searchBtn:hover {
      background: #005c47;
    }
    #churchList {
      max-width: 400px;
      margin: 10px auto;
      font-size: 0.9em;
      background: #f7fdfc;
      border-radius: 5px;
      padding: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    #locateBtn {
      background: #007b5e;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px auto;
      display: block;
    }
    #locateBtn:hover {
      background: #005c47;
    }
  </style>
</head>
<body>

<header>Insengero za ADEPR mu Rwanda</header>

<div id="searchBox">
  <input type="text" id="searchInput" placeholder="Andika izina ry'itorero ushaka..." />
  <button id="searchBtn">Shaka</button>
</div>

<button id="locateBtn">Erekana Insengero Hafi Yanjye</button>

<div id="churchList"></div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  var map = L.map('map').setView([-1.9706, 30.1044], 8);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const churches = [
    { name: "ADEPR Kimisagara", lat: -1.9729, lon: 30.0922, address: "Kimisagara, Kigali" },
    { name: "ADEPR Remera", lat: -1.9353, lon: 30.1026, address: "Remera, Kigali" },
    { name: "ADEPR Nyagatare", lat: -1.2882, lon: 30.3300, address: "Nyagatare, Eastern Province" },
    { name: "ADEPR Musanze", lat: -1.4985, lon: 29.6314, address: "Musanze, Northern Province" }
    // Shyiramo andi matorero
  ];

  // Shyiraho markers
  let markers = [];

  function addMarkers(list) {
    // Siba markers zose zashizeho
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    list.forEach(church => {
      const marker = L.marker([church.lat, church.lon]).addTo(map);
      marker.bindPopup(`<b>${church.name}</b><br>${church.address}`);
      markers.push(marker);
    });
  }

  addMarkers(churches);

  // Search function
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const churchList = document.getElementById('churchList');

  function displayChurchList(list) {
    if(list.length === 0){
      churchList.innerHTML = "<p>Ntaho habonetse insengero zihuye n'ibyo wasabye.</p>";
      return;
    }
    churchList.innerHTML = "<ul>" + list.map(c => `<li><b>${c.name}</b> - ${c.address}</li>`).join('') + "</ul>";
  }

  searchBtn.addEventListener('click', () => {
    const query = searchInput.value.trim().toLowerCase();
    if (!query) {
      displayChurchList(churches);
      addMarkers(churches);
      map.setView([-1.9706, 30.1044], 8);
      return;
    }

    const filtered = churches.filter(church => church.name.toLowerCase().includes(query));
    displayChurchList(filtered);
    addMarkers(filtered);

    if(filtered.length > 0){
      map.setView([filtered[0].lat, filtered[0].lon], 12);
    }
  });

  // Geolocation
  const locateBtn = document.getElementById('locateBtn');
  locateBtn.addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert("Ubushobozi bwo kumenya aho uri ntibuboneka muri browser yawe.");
      return;
    }
    locateBtn.textContent = "Ndimo gushaka aho uri...";
    navigator.geolocation.getCurrentPosition(position => {
      locateBtn.textContent = "Erekana Insengero Hafi Yanjye";
      const { latitude, longitude } = position.coords;
      map.setView([latitude, longitude], 12);

      // Shyira marker yawe aho uri
      L.marker([latitude, longitude]).addTo(map)
        .bindPopup("Aha niho uri").openPopup();

      // Shaka insengero hafi yawe (nko mu radius ya 20km)
      const nearby = churches.filter(ch => {
        const distance = getDistanceFromLatLonInKm(latitude, longitude, ch.lat, ch.lon);
        return distance <= 20;
      });

      displayChurchList(nearby);
      addMarkers(nearby);

      if(nearby.length === 0){
        alert("Nta nsengero za ADEPR ziri hafi yawe mu bilometero 20.");
      }
    }, () => {
      locateBtn.textContent = "Erekana Insengero Hafi Yanjye";
      alert("Ntibishobotse kumenya aho uri.");
    });
  });

  // Function yo kubara intera hagati ya coordinates ebyiri (Haversine formula)
  function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius ya Earth km
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2)
    ;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function deg2rad(deg) {
    return deg * (Math.PI/180)
  }

  // Kwerekana insengero zose kuza kuza page imaze gupakirwa
  displayChurchList(churches);
</script>

</body>
</html>
