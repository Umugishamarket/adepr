<!DOCTYPE html>
<html lang="rw">
<head>
  <meta charset="UTF-8" />
  <title>Insengero za ADEPR mu Rwanda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet/dist/leaflet.css" 
  />
  <style>
    /* Reset and base */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f7fdfc;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header {
      background: #007b5e;
      color: white;
      padding: 16px 12px;
      text-align: center;
      font-size: 1.6rem;
      font-weight: 700;
      box-shadow: 0 3px 7px rgba(0,0,0,0.15);
    }
    #container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 8px 8px 0 8px;
      max-width: 100%;
      margin: 0 auto;
      height: calc(100vh - 60px);
    }
    #sidebar {
      background: white;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      padding: 12px 15px;
      display: flex;
      flex-direction: column;
      max-height: 40vh;
      overflow-y: auto;
      margin-bottom: 8px;
    }
    #searchBox {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    #searchInput {
      flex: 1;
      padding: 12px;
      font-size: 1.1rem;
      border: 1.5px solid #ccc;
      border-radius: 8px;
      outline-offset: 2px;
      transition: border-color 0.3s;
    }
    #searchInput:focus {
      border-color: #007b5e;
    }
    button {
      background: #007b5e;
      border: none;
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.1rem;
      transition: background-color 0.3s;
      user-select: none;
    }
    button:hover, button:focus {
      background: #005c47;
      outline: none;
    }
    #locateBtn {
      margin-bottom: 12px;
    }
    #churchList {
      flex: 1;
      overflow-y: auto;
    }
    #churchList ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #churchList li {
      padding: 12px 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      border: 1.5px solid transparent;
      font-size: 1.1rem;
      transition: background-color 0.3s, border-color 0.3s;
    }
    #churchList li:hover,
    #churchList li:focus {
      background-color: #e6f5f1;
      border-color: #007b5e;
      outline: none;
    }
    #churchList li.active {
      background-color: #007b5e;
      color: white;
      font-weight: 700;
      border-color: #004033;
    }
    #map {
      flex: 1;
      border-radius: 8px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.1);
      min-height: 55vh;
    }
    #loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: 700;
      background: rgba(255,255,255,0.95);
      padding: 15px 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.15);
      display: none;
      z-index: 1000;
      font-size: 1.2rem;
    }

    /* Medium screens and up */
    @media (min-width: 768px) {
      #container {
        flex-direction: row;
        max-width: 1200px;
        height: calc(100vh - 60px);
      }
      #sidebar {
        width: 350px;
        max-height: none;
        margin-bottom: 0;
      }
      #map {
        min-height: auto;
        height: 100%;
      }
    }
  </style>
</head>
<body>

<header>Insengero za ADEPR mu Rwanda</header>

<div id="container">

  <aside id="sidebar" role="complementary" aria-label="Urutonde rw'insengero n'ubushakashatsi">
    <div id="searchBox">
      <input type="search" id="searchInput" placeholder="Andika izina ry'itorero ushaka..." aria-label="Shakisha insengero" />
      <button id="searchBtn" aria-label="Shakisha">Shaka</button>
    </div>
    <button id="locateBtn" aria-label="Erekana insengero hafi yanjye">Erekana Insengero Hafi Yanjye</button>
    <div id="churchList" tabindex="0" aria-live="polite" aria-atomic="true"></div>
  </aside>

  <main id="map" role="region" aria-label="Ikarita y'insengero"></main>
</div>

<div id="loader" aria-live="assertive" aria-atomic="true">Ikarita iri gupakirwa...</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const loader = document.getElementById('loader');
  function showLoader() { loader.style.display = 'block'; }
  function hideLoader() { loader.style.display = 'none'; }

  const churchIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/189/189792.png',
    iconSize: [38, 38],
    iconAnchor: [19, 38],
    popupAnchor: [0, -38]
  });

  var map = L.map('map').setView([-1.9706, 30.1044], 8);
  showLoader();

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  map.whenReady(() => { hideLoader(); });

  const churches = [
    {
      name: "ADEPR Kimisagara",
      lat: -1.9729,
      lon: 30.0922,
      address: "Kimisagara, Kigali",
      leader: "Pasiteri Jean Bosco",
      phone: "+250 788 123 456",
      email: "kimisagara@adepr.rw",
      serviceHours: "Ku wa 1 - Ku wa 7, 7:00 AM - 12:00 PM"
    },
    {
      name: "ADEPR Remera",
      lat: -1.9353,
      lon: 30.1026,
      address: "Remera, Kigali",
      leader: "Pasiteri Alice Uwimana",
      phone: "+250 789 654 321",
      email: "remera@adepr.rw",
      serviceHours: "Ku Cyumweru na Ku wa Gatatu, 8:00 AM - 11:00 AM"
    },
    {
      name: "ADEPR Nyagatare",
      lat: -1.2882,
      lon: 30.3300,
      address: "Nyagatare, Eastern Province",
      leader: "Pasiteri Emmanuel Nkurunziza",
      phone: "+250 780 111 222",
      email: "nyagatare@adepr.rw",
      serviceHours: "Ku Cyumweru, 9:00 AM - 12:00 PM"
    },
    {
      name: "ADEPR Musanze",
      lat: -1.4985,
      lon: 29.6314,
      address: "Musanze, Northern Province",
      leader: "Pasiteri Marie Claire",
      phone: "+250 781 333 444",
      email: "musanze@adepr.rw",
      serviceHours: "Ku Cyumweru, 7:30 AM - 11:30 AM"
    }
  ];

  let markers = [];
  const churchList = document.getElementById('churchList');

  function clearMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
  }

  function addMarkers(list) {
    clearMarkers();
    list.forEach((church, index) => {
      const marker = L.marker([church.lat, church.lon], {icon: churchIcon}).addTo(map);
      const popupContent = `
        <div style="font-weight:bold; font-size:1.1em; margin-bottom:6px;">${church.name}</div>
        <div><strong>Aho iherereye:</strong> ${church.address}</div>
        <div><strong>Umuyobozi:</strong> ${church.leader}</div>
        <div><strong>Telefone:</strong> ${church.phone}</div>
        <div><strong>Email:</strong> <a href="mailto:${church.email}">${church.email}</a></div>
        <div><strong>Amasaha yo gusenga:</strong> ${church.serviceHours}</div>
      `;
      marker.bindPopup(popupContent);
      marker.on('click', () => {
        setActiveListItem(index);
      });
      markers.push(marker);
    });
  }

  function displayChurchList(list) {
    if(list.length === 0) {
      churchList.innerHTML = "<p>Nta nsengero zihari zahuye n'ibyo wasabye.</p>";
      return;
    }
    churchList.innerHTML = "<ul>" + list.map((church, i) => `
      <li tabindex="0" data-index="${i}">${church.name}<br><small>${church.address}</small></li>
    `).join('') + "</ul>";

    const items = churchList.querySelectorAll('li');
    items.forEach(item => {
      item.addEventListener('click', () => {
        const i = parseInt(item.getAttribute('data-index'));
        markers[i].openPopup();
        map.setView([list[i].lat, list[i].lon], 13);
        setActiveListItem(i);
      });
      item.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          item.click();
        }
      });
    });

    setActiveListItem(0);
  }

  function setActiveListItem(index) {
    const items = churchList.querySelectorAll('li');
    items.forEach(item => item.classList.remove('active'));
    if(items[index]){
      items[index].classList.add('active');
      // Scroll to item smoothly
      items[index].scrollIntoView({behavior: "smooth", block: "center"});
    }
  }

  function searchChurches() {
    const term = document.getElementById('searchInput').value.trim().toLowerCase();
    if(term === '') {
      addMarkers(churches);
      displayChurchList(churches);
      map.setView([-1.9706, 30.1044], 8);
      return;
    }
    const filtered = churches.filter(ch => ch.name.toLowerCase().includes(term) || ch.address.toLowerCase().includes(term));
    addMarkers(filtered);
    displayChurchList(filtered);
    if(filtered.length > 0) {
      map.setView([filtered[0].lat, filtered[0].lon], 12);
    }
  }

  function locateUser() {
    if(!navigator.geolocation) {
      alert("Igikoresho cyawe ntigishyigikira uburyo bwo kumenya aho uri.");
      return;
    }
    showLoader();
    navigator.geolocation.getCurrentPosition(position => {
      hideLoader();
      const {latitude, longitude} = position.coords;
      map.setView([latitude, longitude], 12);
      const userMarker = L.circleMarker([latitude, longitude], {
        radius: 9,
        fillColor: "#007b5e",
        color: "#004033",
        weight: 2,
        opacity: 0.9,
        fillOpacity: 0.7
      }).addTo(map).bindPopup("Aha ndi njye!").openPopup();
    }, err => {
      hideLoader();
      alert("Ntibishobotse kumenya aho uri: " + err.message);
    });
  }

  document.getElementById('searchBtn').addEventListener('click', searchChurches);
  document.getElementById('searchInput').addEventListener('keydown', (e) => {
    if(e.key === 'Enter') {
      e.preventDefault();
      searchChurches();
    }
  });

  document.getElementById('locateBtn').addEventListener('click', locateUser);

  // Initialize
  addMarkers(churches);
  displayChurchList(churches);

</script>

</body>
</html>
